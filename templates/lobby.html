<head>
    <link rel="icon" href="{{ url_for('static', filename='/icon/icon.png') }}" type="image/png">
</head>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<body>
    <h1>SUPERBE PARTIE DE BLOCKUS</h1>
    <table border="1" id="tupleTable">
        <tr>
            <th>VOUS ETES UN JOUEUR</th>
        </tr>
    </table>

    <script>
        const idgame = "{{ idgame }}"
        function fetchData() {
            launch()
            fetch(`/getdatagame/${idgame}`) //envoie une requête pour avoir le json
                .then(response => response.json()) // transforme pour pouvoir traiter la requête
                .then(data => {
                    const table = document.getElementById('tupleTable'); //on va chercher ici la table html
                    table.innerHTML = `
                        <tr>
                            <th>Name</th>
                        </tr>
                    `; // L'intérieur de la table c'est maintenant ce que précède
                    data.forEach(([name]) => {
                        const row = document.createElement('tr'); // on a une nouvelle ligne
                        row.innerHTML = `<td>${name}</td>`;
                        table.appendChild(row); // on rajoute la nouvelle ligne
                    });
                })
                .catch(error => console.error('Error fetching data:', error)); // envoie une erreur si le programme explose
        }
        function launch(){
            fetch(`/getdatalaunch/${idgame}`)
                .then(response =>response.json())
                .then(data => {if (data !== -1) {
                        // Redirige si il y a pas un -1 on redirige
                        window.location.href = `/grille/${idgame}`; 
                    }})
            .catch(error => console.error('Erreur sur les données :', error));
                
        }
        const socket = io();
        socket.on('connect', () => {
            console.log('Socket connecté');
            socket.emit('join_room', { room: idgame })
        });
        socket.on('new_player', (data) =>{
            const son = new Audio('{{ url_for("static", filename="sounds/blipW.wav") }}');     
            console.log("son")
            son.play();
            console.log("new player in lobby")
            fetchData();
        })
        socket.on('launch',(data) =>{
            console.log("launching the game")
            launch();
        })

    </script>