<title> BLOKUS PP2I grp6 </title>

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
</head>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<body>
<div class="bandeau"> 
    <div class="bandeau_inner"> 
        <a href="/" class="bandeau_titre"> Jeu du BLOKUS </a> 
    </div>
</div>

<div class="infoPartie"> 
    <h1> Liste des joueurs de la partie</h1>
</div>    
<div>
    <table border="1" id="tupleTable">
        <tr>
            <th>VOUS ETES UN ADMIN</th>
        </tr>
    </table>
    <div>
        <button id="IA" onclick="addIA()">RAJOUTER IA</button>
        <button id="Launch" onclick="sendRequest()">LANCER LA PARTIE!</button>
    </div>
</div>
</body>

<div class="footer">
    <span class="gras souligne"> Crédits:</span> Briand Thibault, Regennass Anne, Girres Elisa, Denys Angèle
</div>

<script>
    const idgame = "{{ idgame }}"
    function fetchData() {
        fetch(`/getdatagame/${idgame}`) //envoie une requête pour avoir le json
            .then(response => response.json()) // transforme pour pouvoir traiter la requête
            .then(data => {
                const table = document.getElementById('tupleTable'); //on va chercher ici la table html
                table.innerHTML = `
                    <tr>
                        <th>Name</th>
                    </tr>
                `; // L'intérieur de la table c'est maintenant ce que précède
                data.forEach(([name]) => {
                    const row = document.createElement('tr'); // on a une nouvelle ligne
                    row.innerHTML = `<td>${name}</td>`;
                    table.appendChild(row); // on rajoute la nouvelle ligne
                });
            })
            .catch(error => console.error('Error fetching data:', error)); // envoie une erreur si le programme explose
    }

    function launch(){
        fetch(`/getdatalaunch/${idgame}`)
            .then(response =>response.json())
            .then(data =>{
        if (typeof data === 'undefined' || data === null) {
            return; // ON FAIT EXPLOSER
        }
        if (data !== -1) {
            // si c'est different de -1
            window.location.href = `/grille/${idgame}`;
        }}
    )
    .catch(error => {
        return;
    });

    }
    const socket = io();

    socket.on('connect', () => {
        console.log('Socket connecté');
        socket.emit('join_room', { room: idgame })
    });

    socket.on('new_player', (data) =>{
        console.log("new player in lobby")
        fetchData();
    })
    fetchData()
    socket.on('launch',(data) =>{
        console.log("launching the game")
        launch();
    })
        
    function addIA(){
        //envoie une requête pour rajouter une IA à la partie
        fetch(`/addIA/${idgame}`,{
            method : 'POST'
        })
        return false;
    }

    function sendRequest() {
        // Envoie la requête qui va modifier la base de donnée pour lancer la partie
        fetch(`/launchgame/${idgame}`, {
            method: 'POST'
        })
        return false;  
    }
</script>